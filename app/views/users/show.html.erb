<% 

provide(:title, @user.name) 

activities = @user.activities.clone
activities.sort_by{|e| e[:activity_date]}

totalCaloriesBurned = 0

activities.each do |activity| 
  if(activity.activity_date > @user.sins.first.date)
    totalCaloriesBurned += activity.calories
  end
end

%>

<div class="row">
  <aside class="span12">
    <section>
      <h1><%= @user.name %></h1>
      <% if @user == current_user && current_user.rk_token %>
        <%= link_to "Sync Activities", '/getactivities', class: "btn btn-large btn-primary" %>
      <% elsif @user == current_user %>
        <%= link_to "Connect to RunKeeper", '/auth/runkeeper', class: "btn btn-large btn-primary" %>
      <% end %>
      <% if @user.rk_token %>
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Binge Type</th>
            <th>Date</th>
            <th>Calories Consumed</th>
            <th>Calories Burned</th>
            <th>Percent complete</th>
          </tr>
        </thead>
        <tbody>
          <% @user.sins.each do |sin| %>
            <tr>
              <td><%= sintype = SinType.find(sin.sin_type_id)
                      sintype.name %></td>
              <td><%= sin.date %></td>
              <td><%= caloriesBurnedThisActivity = sintype.calories * sin.quantity 
                      caloriesBurnedThisActivity %></td>
              <td><%= if(totalCaloriesBurned - caloriesBurnedThisActivity > 0)
                        '100%'
                      else
                        percentage = totalCaloriesBurned / caloriesBurnedThisActivity * 100
                        if(percentage > 0)
                          percentage.floor + '%'
                        else
                          '0%'
                        end 
                      end

                      totalCaloriesBurned -= caloriesBurnedThisActivity;

              totalCaloriesBurned %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <% end %>
    </section>
  </aside>
</div>